<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | ResumeReader</title>
    <style>
        /* --- CSS STYLES --- */
        body { margin: 0; font-family: Arial, sans-serif; background: #ffffff; }
        .container { display: flex; height: 100vh; }
        
        /* Left Box (Logo) */
        .left-box { width: 50%; background: #ffffff; display: flex; justify-content: center; align-items: center; }
        .logo-placeholder { width: 350px; height: 350px; display: flex; justify-content: center; align-items: center; }
        .logo { width: 350px; }

        /* Right Box (Form) */
        .right-box { width: 50%; padding: 40px 60px; display: flex; flex-direction: column; justify-content: center; }
        h1 { font-size: 38px; margin-bottom: 25px; }
        label { font-size: 16px; font-weight: bold; display: block; margin-top: 15px; }
        input { width: 100%; margin-top: 5px; margin-bottom: 5px; padding: 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .forgot { display: block; margin-bottom: 20px; font-size: 14px; text-decoration: none; color: #007bff; margin-top: 5px; cursor: pointer; }
        .login-btn { width: 100%; padding: 12px; border: none; background: #96b7b7; font-size: 16px; color: #000; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .login-btn:hover { opacity: 0.9; }

        .footer-links { text-align: center; width: 100%; margin-top: 20px; }
        .footer-links p { margin-bottom: 0.5rem; color: #555; }
        .footer-links a { color: #007bff; text-decoration: none; }
        .copyright { color: #888; font-size: 0.8rem; margin-top: 1rem; }

        /* --- MODAL STYLES (Important for Popup) --- */
        .modal {
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.5); /* Dimmed background */
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            width: 400px;
            border-radius: 12px;
            text-align: center;
            border: 4px solid #8cb3b3; /* Teal border from image */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 24px; }
        .modal-content label { text-align: left; margin-bottom: 5px; }
        .modal-content input { background-color: #e0ebeb; /* Light teal input bg */ }

        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

        .confirm-btn { flex: 1; padding: 10px; background: #2ecc71; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .confirm-btn:hover { background: #27ae60; }

        .cancel-btn { flex: 1; padding: 10px; background: #e74c3c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .cancel-btn:hover { background: #c0392b; }

        .error-msg { color: #d9534f; font-weight: bold; margin-bottom: 10px; font-size: 14px; text-align: left; }
        .sent-to-text { font-size: 14px; color: #555; margin-bottom: 15px; }

        /* Resend Link Styles */
        .resend-block { margin-top: 5px; text-align: right; font-size: 13px; }
        .resend-link { color: #007bff; text-decoration: underline; cursor: pointer; }
        .resend-link.disabled { color: #999; cursor: default; text-decoration: none; }
        .counter { color: #666; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="left-box">
        <div class="logo-placeholder">
            <img src="image/logo.jpg" class="logo" alt="Resume Reader Logo">
        </div>
    </div>

    <div class="right-box">
        <h1>Login</h1>

        <form action="login.php" method="POST">
            <label>Email</label>
            <input type="email" name="email" placeholder="Email" required>

            <label>Password</label>
            <input type="password" name="password" required>

            <a href="#" class="forgot" onclick="openEmailModal(event)">Forgot Password?</a>

            <button type="submit" class="login-btn">Login</button>
        </form>

        <div class="footer-links">
            <p>Donâ€™t have an account? <a href="register.php">Register here</a></p>
            <p class="copyright">Copyright 2025 | ResumeReader</p>
        </div>
    </div>
</div>

<div id="emailModal" class="modal">
    <div class="modal-content">
        <h3>Forgot Password</h3>
        
        <div id="emailError" class="error-msg" style="display:none;"></div>

        <label for="fpEmail">Email</label>
        <input type="email" id="fpEmail" placeholder="Enter your email">

        <div class="modal-actions">
            <button onclick="sendCode()" class="confirm-btn">Confirm</button>
            <button onclick="closeEmailModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<div id="codeModal" class="modal">
    <div class="modal-content">
        <h3>Verification Code</h3>

        <p id="emailDisplay" class="sent-to-text">Verification code sent to <b>***@gmail.com</b></p>
        <div id="codeError" class="error-msg" style="display:none;"></div>

        <label for="verifyCode">Verification Code</label>
        <input type="text" id="verifyCode" maxlength="6" placeholder="Verification Code">

        <div class="resend-block">
            <span id="resendCounter" class="counter"></span>
            <a id="resendLink" class="resend-link disabled" onclick="resendCode()">Resend Code</a>
        </div>

        <div class="modal-actions">
            <button onclick="checkCode()" class="confirm-btn">Confirm</button>
            <button onclick="closeCodeModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<div id="updateModal" class="modal">
    <div class="modal-content">
        <h3>Update New Password</h3>

        <div id="updateError" class="error-msg" style="display:none;"></div>

        <label for="newPassword">New Password</label>
        <input type="password" id="newPassword" placeholder="New Password">

        <label for="confirmPassword">Confirm New Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm New Password">

        <div class="modal-actions">
            <button onclick="updatePassword()" class="confirm-btn">Confirm</button>
            <button onclick="closeUpdateModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<script>
/* ================= JAVASCRIPT LOGIC ================= */

let sentCode = "";
let currentEmail = "";
let resendTimer = null;
const RESEND_SECONDS = 30;

/* --- Step 1: Email Modal --- */
function openEmailModal(e) {
    if(e) e.preventDefault();
    document.getElementById("fpEmail").value = '';
    document.getElementById("emailError").style.display = 'none';
    document.getElementById("emailModal").style.display = "flex";
}

function closeEmailModal() { 
    document.getElementById("emailModal").style.display = "none"; 
}

/* --- Step 2: Send Code (Updated to check DB) --- */
function sendCode() {
    const emailInput = document.getElementById("fpEmail").value.trim();
    const emailError = document.getElementById("emailError");
    emailError.style.display = 'none';

    // Basic format check
    if (!emailInput || !emailInput.includes("@")) {
        emailError.innerText = "Please enter a valid email address.";
        emailError.style.display = "block";
        return;
    }

    // Call Server to Check DB and Send Email
    const formData = new FormData();
    formData.append('email', emailInput);

    fetch('send_code.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'error') {
            // Show "Invalid email" message
            emailError.innerText = data.message;
            emailError.style.display = "block";
        } else {
            // Success: Email found and code generated
            currentEmail = emailInput;
            
            // Store code in session storage for Step 3 verification
            sentCode = String(data.code); 
            sessionStorage.setItem("fp_sent_code", sentCode);
            
            // For testing on localhost if email fails:
            console.log("Server generated code:", sentCode); 

            // Update UI
            const masked = maskEmail(currentEmail);
            document.getElementById("emailDisplay").innerHTML = `Verification code sent to <b>${masked}</b>`;

            // Switch Modals
            document.getElementById("verifyCode").value = '';
            document.getElementById("codeError").style.display = 'none';
            closeEmailModal();
            document.getElementById("codeModal").style.display = "flex";

            // Start Timer
            startResendCountdown(RESEND_SECONDS);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        emailError.innerText = "System error. Please try again later.";
        emailError.style.display = "block";
    });
}

// Helper to mask email
function maskEmail(email) {
    const parts = email.split("@");
    if (parts.length !== 2) return email;
    const local = parts[0];
    if (local.length <= 2) return "***@" + parts[1];
    return local[0] + "***" + local.slice(-1) + "@" + parts[1];
}

/* --- Timer Logic --- */
function startResendCountdown(seconds){
    const counter = document.getElementById("resendCounter");
    const link = document.getElementById("resendLink");
    
    link.classList.add("disabled");
    link.style.pointerEvents = "none";

    let left = seconds;
    counter.innerText = `Resend available in ${left}s`;

    if (resendTimer) clearInterval(resendTimer);
    
    resendTimer = setInterval(() => {
        left--;
        if (left <= 0) {
            clearInterval(resendTimer);
            counter.innerText = '';
            link.classList.remove("disabled");
            link.style.pointerEvents = "auto";
        } else {
            counter.innerText = `Resend available in ${left}s`;
        }
    }, 1000);
}

function resendCode() {
    // Re-use the PHP file to send a new code
    const formData = new FormData();
    formData.append('email', currentEmail);

    fetch('send_code.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            sentCode = String(data.code);
            sessionStorage.setItem("fp_sent_code", sentCode);
            console.log("Resent code:", sentCode); // Check console if email fails
            
            alert("A new verification code has been sent to your email.");
            startResendCountdown(RESEND_SECONDS);
        } else {
            alert("Failed to resend code.");
        }
    })
    .catch(error => console.error(error));
}

function closeCodeModal() {
    document.getElementById("codeModal").style.display = "none";
    if (resendTimer) clearInterval(resendTimer);
}

/* --- Step 3: Check Code --- */
function checkCode() {
    const codeInput = document.getElementById("verifyCode").value.trim();
    const stored = sessionStorage.getItem("fp_sent_code");
    const codeError = document.getElementById("codeError");
    codeError.style.display = 'none';

    if (!codeInput) {
        codeError.innerText = "Please enter the verification code.";
        codeError.style.display = "block";
        return;
    }

    if (codeInput !== stored) {
        // Updated error message logic per request
        alert("Wrong verification code, please try again."); 
        document.getElementById("verifyCode").value = ""; // Clear input
        return;
    }

    alert("Email verified, please update your password.");
    closeCodeModal();

    // Prepare Step 3
    document.getElementById("newPassword").value = "";
    document.getElementById("confirmPassword").value = "";
    document.getElementById("updateError").style.display = "none";
    document.getElementById("updateModal").style.display = "flex";
}

function closeUpdateModal() {
    document.getElementById("updateModal").style.display = "none";
}

/* --- Step 4: Update Password --- */
function updatePassword() {
    const pass1 = document.getElementById("newPassword").value;
    const pass2 = document.getElementById("confirmPassword").value;
    const updateError = document.getElementById("updateError");
    updateError.style.display = 'none';

    // Client Validations
    if (pass1.length < 6) {
        updateError.innerText = "Password must be at least 6 characters long.";
        updateError.style.display = "block";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
        return;
    }

    if (pass1 !== pass2) {
        updateError.innerText = "Password does not match. Please try again.";
        updateError.style.display = "block";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
        return;
    }

    // Call Server
    fetch("update_password.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `email=${encodeURIComponent(currentEmail)}&password=${encodeURIComponent(pass1)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) { // Note: using data.success based on your PHP
            alert("Password updated successfully. Please use the new password to login.");
            closeUpdateModal();
        } else {
            updateError.innerText = data.error || "Error updating password.";
            updateError.style.display = "block";
            // allow user to try again without clearing inputs immediately
        }
    })
    .catch(err => {
        console.error(err);
        updateError.innerText = "An error occurred while updating the password.";
        updateError.style.display = "block";
    });
}
</script>

</body>
</html>