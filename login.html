<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | ResumeReader</title>
    <link rel="stylesheet" href="login.css">
</head>
<body>

<div class="container">
    <div class="left-box">
        <div class="logo-placeholder">
            <img src="image/logo.jpg" class="logo" alt="Resume Reader Logo">
        </div>
    </div>

    <div class="right-box">
        <h1>Login</h1>

        <form action="login.php" method="POST">
            <label>Email</label>
            <input type="email" name="email" placeholder="Email" required>

            <label>Password</label>
            <input type="password" name="password" required>

            <a href="#" class="forgot" onclick="openEmailModal()">Forgot Password?</a>

            <button type="submit" class="login-btn">Login</button>
        </form>

        <div class="footer-links">
            <p>Don't have an account? <a href="register.php">Register here</a></p>
            <p class="copyright">Copyright 2025 | ResumeReader</p>
        </div>
    </div>
</div>

<!-- Forgot Password Modal - Step 1: Email Input -->
<div id="emailModal" class="modal">
    <div class="modal-content">
        <h3>Forgot Password</h3>
        <div id="emailError" class="error-msg"></div>
        <label>Email</label>
        <input type="email" id="fpEmail" placeholder="Enter your email">
        <div class="modal-buttons">
            <button onclick="sendCode()" class="confirm-btn">Get the New Password</button>
            <button onclick="closeEmailModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Forgot Password Modal - Step 2: Verification Code -->
<div id="codeModal" class="modal">
    <div class="modal-content">
        <h3>Verification Code</h3>
        <p id="emailDisplay" class="sent-to-text">A verification code has been sent to your email.</p>
        <div id="codeError" class="error-msg"></div>
        <label>Verification Code</label>
        <input type="text" id="verifyCode" maxlength="6" placeholder="6-digit code">
        <div class="modal-buttons">
            <button onclick="checkCode()" class="confirm-btn">Confirm</button>
            <button onclick="closeCodeModal()" class="cancel-btn">Cancel</button>
        </div>
        <a href="#" onclick="resendCode()" class="resend-link">Resend Code</a>
    </div>
</div>

<!-- Forgot Password Modal - Step 3: Update Password -->
<div id="updateModal" class="modal">
    <div class="modal-content">
        <h3>Update New Password</h3>
        <div id="updateError" class="error-msg"></div>
        <label>New Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password">
        <label>Confirm New Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm new password">
        <div class="modal-buttons">
            <button onclick="updatePassword()" class="confirm-btn">Confirm</button>
            <button onclick="closeUpdateModal()" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>

<script>
let currentEmail = "";

// --- Step 1: Open Email Input Modal ---
function openEmailModal() {
    document.getElementById("fpEmail").value = '';
    document.getElementById("emailError").innerHTML = '';
    document.getElementById("emailModal").style.display = "flex";
}

function closeEmailModal() {
    document.getElementById("emailModal").style.display = "none";
}

// --- Step 2: Send Code ---
function sendCode() {
    currentEmail = document.getElementById("fpEmail").value.trim();
    document.getElementById("emailError").innerHTML = '';

    if (currentEmail === "" || !currentEmail.includes('@')) {
        document.getElementById("emailError").innerHTML = "Please enter a valid email address.";
        return;
    }

    // Send request to backend to generate and send code
    fetch("send_reset_code.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `email=${encodeURIComponent(currentEmail)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Transition to Step 2 Modal
            const maskedEmail = currentEmail.replace(/^(.)(.*)(@.*)$/, (_, a, b, c) => 
                a + '*'.repeat(b.length) + c);
            document.getElementById("emailDisplay").innerHTML = 
                `A verification code has been sent to <b>${maskedEmail}</b>`;

            document.getElementById("verifyCode").value = '';
            document.getElementById("codeError").innerHTML = '';
            closeEmailModal();
            document.getElementById("codeModal").style.display = "flex";
        } else {
            document.getElementById("emailError").innerHTML = data.message || "Error sending verification code.";
        }
    })
    .catch(error => {
        document.getElementById("emailError").innerHTML = "An error occurred. Please try again.";
        console.error('Error:', error);
    });
}

// --- Step 2: Check Code ---
function checkCode() {
    let userCode = document.getElementById("verifyCode").value.trim();
    document.getElementById("codeError").innerHTML = '';

    if (userCode.length !== 6) {
        document.getElementById("codeError").innerHTML = "Please enter a 6-digit code.";
        return;
    }

    // Verify code with backend
    fetch("verify_reset_code.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `email=${encodeURIComponent(currentEmail)}&code=${encodeURIComponent(userCode)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Code verified successfully! Transition to Step 3
            document.getElementById("newPassword").value = '';
            document.getElementById("confirmPassword").value = '';
            document.getElementById("updateError").innerHTML = '';
            closeCodeModal();
            document.getElementById("updateModal").style.display = "flex";
        } else {
            document.getElementById("codeError").innerHTML = data.message || "Incorrect verification code!";
        }
    })
    .catch(error => {
        document.getElementById("codeError").innerHTML = "An error occurred. Please try again.";
        console.error('Error:', error);
    });
}

function closeCodeModal() {
    document.getElementById("codeModal").style.display = "none";
}

function resendCode() {
    sendCode();
}

// --- Step 3: Update Password ---
function updatePassword() {
    let pass1 = document.getElementById("newPassword").value;
    let pass2 = document.getElementById("confirmPassword").value;
    document.getElementById("updateError").innerHTML = '';

    if (pass1.length < 6) {
        document.getElementById("updateError").innerHTML = "Password must be at least 6 characters long.";
        return;
    }

    if (pass1 !== pass2) {
        document.getElementById("updateError").innerHTML = "Passwords do not match!";
        return;
    }

    // Update password via backend
    fetch("update_password.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `email=${encodeURIComponent(currentEmail)}&password=${encodeURIComponent(pass1)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Password updated successfully! You can now login with your new password.");
            closeUpdateModal();
        } else {
            document.getElementById("updateError").innerHTML = data.message || "Error updating password.";
        }
    })
    .catch(error => {
        document.getElementById("updateError").innerHTML = "An error occurred during password update.";
        console.error('Error:', error);
    });
}

function closeUpdateModal() {
    document.getElementById("updateModal").style.display = "none";
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.getElementsByClassName('modal');
    for (let modal of modals) {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    }
}
</script>

</body>
</html>